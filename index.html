<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞—Ñ–∏–∫ - –®–æ—Ñ—å–æ—Ä–∏</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: auto; }
        header { background: #1a73e8; color: white; padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 20px; }
        .driver-card { 
            background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 8px solid #1a73e8;
        }
        h2 { margin-top: 0; color: #1a73e8; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .field { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; font-size: 0.9rem; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .result-box { background: #e8f0fe; border: 1px solid #1a73e8; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .comp-alert { color: #d93025; font-weight: bold; }
        .last-update { font-size: 0.75rem; color: #888; text-align: right; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>–ü–æ—á–∏–≤–∫–∏ –Ω–∞ —à–æ—Ñ—å–æ—Ä–∏—Ç–µ</h1>
        <p>*–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ —Ä–µ–∞–ª–Ω–æ –≤—Ä–µ–º–µ</p>
    </header>

    <div id="drivers-app"></div>
</div>
    <script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–£–≤–µ—Ä–∏ —Å–µ, —á–µ —Ç—É–∫ —Å–∞ —Ç–≤–æ–∏—Ç–µ –∫–ª—é—á–æ–≤–µ –æ—Ç Firebase)
    
const firebaseConfig = {
  apiKey: "AIzaSyCyU3AAknlL83MIjWGkW8nruoedoqAzQvM",
  authDomain: "drivers-rest.firebaseapp.com",
  databaseURL: "https://drivers-rest-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "drivers-rest",
  storageBucket: "drivers-rest.firebasestorage.app",
  messagingSenderId: "529444101854",
  appId: "1:529444101854:web:31ac6403eb77786ea6ac4f",
  measurementId: "G-L641BV1YH6"
  };
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const drivers = ["–ò–≤—á–æ", "–ö—Ä–∞—Å–∏", "–ò–ª–∏—è–Ω", "–†—É–º–µ–Ω"];

// 2. –ì–ï–ù–ï–†–ò–†–ê–ù–ï –ù–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê
const appContainer = document.getElementById('drivers-app');
drivers.forEach((name, index) => {
    const card = document.createElement('div');
    card.className = 'driver-card';
    card.innerHTML = `
        <h2>üë§ ${name}</h2>
        <div class="field">
            <label>–ü–æ—Å–ª–µ–¥–Ω–∞ —Å–µ–¥–º–∏—á–Ω–∞ –ø–æ—á–∏–≤–∫–∞:</label>
            <select id="type-${index}">
                <option value="full">–ü—ä–ª–Ω–∞ (45—á+)</option>
                <option value="reduced">–°—ä–∫—Ä–∞—Ç–µ–Ω–∞ (–ø–æ–¥ 45—á)</option>
            </select>
        </div>
        <div id="comp-ui-${index}" class="field" style="display:none;">
            <label>–í–∑–µ—Ç–∏ —á–∞—Å–æ–≤–µ –ø–æ—á–∏–≤–∫–∞:</label>
            <input type="number" id="hours-${index}" placeholder="–ù–∞–ø—Ä. 24">
        </div>
        <div class="field">
            <label>–ù–∞—á–∞–ª–æ –Ω–∞ —Ç–µ–∫—É—â–∞ —Å–µ–¥–º–∏—Ü–∞:</label>
            <input type="datetime-local" id="start-${index}">
        </div>
        <div class="result-box" id="res-${index}">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏...</div>
        <div class="last-update" id="time-${index}">-</div>
    `;
    appContainer.appendChild(card);

    // –°–ª—É—à–∞—Ç–µ–ª–∏ –∑–∞ –ø—Ä–æ–º–µ–Ω–∏ (–∑–∞–¥–µ–π—Å—Ç–≤–∞—Ç –∑–∞–ø–∏—Å)
    ['type-', 'hours-', 'start-'].forEach(idPrefix => {
        document.getElementById(idPrefix + index).addEventListener('change', () => saveData(index));
    });
});

// 3. –§–£–ù–ö–¶–ò–Ø –ó–ê –ó–ê–ü–ò–° (–° –ü–ê–†–û–õ–ê)
async function saveData(index) {
    let sessionKey = sessionStorage.getItem('driver_key');
    
    // –ê–∫–æ –Ω—è–º–∞ –∑–∞–ø–∏—Å–∞–Ω–∞ –ø–∞—Ä–æ–ª–∞ –∑–∞ —Å–µ—Å–∏—è—Ç–∞, —è –∏—Å–∫–∞–º–µ –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è
    if (!sessionKey) {
        sessionKey = prompt("–í—ä–≤–µ–¥–µ—Ç–µ –ø–∞—Ä–æ–ª–∞ –∑–∞ –æ—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:");
        if (!sessionKey) return; 
        sessionStorage.setItem('driver_key', sessionKey);
    }

    const data = {
        type: document.getElementById(`type-${index}`).value,
        hours: document.getElementById(`hours-${index}`).value || 0,
        start: document.getElementById(`start-${index}`).value,
        updatedAt: new Date().toLocaleString('bg-BG'),
        // –¢–û–í–ê –ü–û–õ–ï –ï –ö–õ–Æ–ß–û–í–û –ó–ê –¢–í–û–ò–¢–ï SECURITY RULES
        secret_key: sessionKey 
    };

    try {
        await set(ref(db, 'drivers/' + index), data);
        console.log("–î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∏—Å–∞–Ω–∏ —É—Å–ø–µ—à–Ω–æ!");
    } catch (error) {
        alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å! –ü–∞—Ä–æ–ª–∞—Ç–∞ –µ –≥—Ä–µ—à–Ω–∞ –∏–ª–∏ –Ω—è–º–∞—Ç–µ –¥–æ—Å—Ç—ä–ø.");
        sessionStorage.removeItem('driver_key'); // –ò–∑—á–∏—Å—Ç–≤–∞–º–µ –≥—Ä–µ—à–Ω–∞—Ç–∞ –ø–∞—Ä–æ–ª–∞, –∑–∞ –¥–∞ –ø–∏—Ç–∞ –ø–∞–∫
        location.reload(); // –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–º–µ –∑–∞ —Å–∏–Ω—Ö—Ä–æ–Ω
    }
}

// 4. –°–õ–£–®–ê–¢–ï–õ –ó–ê –ü–†–û–ú–ï–ù–ò (–ß–ï–¢–ï–ù–ï –í –†–ï–ê–õ–ù–û –í–†–ï–ú–ï)
onValue(ref(db, 'drivers/'), (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    for (let index in data) {
        const d = data[index];
        const resEl = document.getElementById(`res-${index}`);
        const timeEl = document.getElementById(`time-${index}`);

        // –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–∞–º–µ –ø–æ–ª–µ—Ç–∞—Ç–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–∞–∫–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –Ω–µ –ø–∏—à–µ –≤ –º–æ–º–µ–Ω—Ç–∞)
        if (!document.activeElement || document.activeElement.id.indexOf(index) === -1) {
            if(document.getElementById(`type-${index}`)) document.getElementById(`type-${index}`).value = d.type;
            if(document.getElementById(`hours-${index}`)) document.getElementById(`hours-${index}`).value = d.hours;
            if(document.getElementById(`start-${index}`)) document.getElementById(`start-${index}`).value = d.start;
        }

        document.getElementById(`comp-ui-${index}`).style.display = (d.type === 'reduced') ? 'block' : 'none';
        timeEl.innerText = "–ü–æ—Å–ª–µ–¥–Ω–∞ –ø—Ä–æ–º—è–Ω–∞: " + (d.updatedAt || "-");

        // –ü–†–ï–°–ú–Ø–¢–ê–ù–ï –ù–ê –õ–û–ì–ò–ö–ê–¢–ê
        if (d.start) {
            const startDate = new Date(d.start);
            const deadline = new Date(startDate.getTime() + (144 * 60 * 60 * 1000));
            let minRest = 45;
            let compTxt = "";

            if (d.type === 'reduced' && d.hours) {
                const diff = 45 - parseFloat(d.hours);
                if (diff > 0) {
                    minRest = 45 + diff;
                    compTxt = `<br><span style="color: #d93025; font-weight: bold;">+ –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: ${diff}—á.</span>`;
                }
            }

            resEl.innerHTML = `üèÅ <strong>–°—Ä–æ–∫ –¥–æ:</strong> ${deadline.toLocaleString('bg-BG')}<br>
                               ‚è≥ <strong>–°–ª–µ–¥–≤–∞—â–∞ –ø–æ—á–∏–≤–∫–∞:</strong> ${minRest} —á–∞—Å–∞ ${compTxt}`;
        }
    }
});
</script>

</body>
</html>
